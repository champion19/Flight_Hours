#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# An example hook script to verify what is about to be pushed. Called by "git
# push" after it has checked the remote status, but before anything has been
# pushed. If this script exits with a non-zero status, nothing will be pushed.
#
# This hook is called with the following parameters:
#
# $1 -- Name of the remote to which the push is being done
# $2 -- URL to which the push is being done
#
# If pushing without using a named remote, those arguments will be equal.
#
# Information about the commits which are being pushed is supplied as lines to
# the standard input in the form:
#
#   <local ref> <local oid> <remote ref> <remote oid>
#
# This sample shows how to prevent push of commits where the log message starts
# with "WIP" (work in progress).
echo "üîç Ejecutando pruebas de Flutter..."
flutter test --coverage

if [ $? -ne 0 ]; then
    echo "‚ùå Las pruebas fallaron. No se permitir√° el push."
    exit 1
fi

COVERAGE_FILE="coverage/lcov.info"

if [ -f "$COVERAGE_FILE" ]; then
    # Obt√©n la cobertura actual desde el archivo de cobertura
    ACTUAL_COVERAGE=$(genhtml "$COVERAGE_FILE" -o coverage/html | grep "lines" | awk '{print $2}' | tr -d '.' | cut -d'%' -f1)

    # Imprime el valor exacto para depurar
    echo "DEBUG: Valor calculado para cobertura: $ACTUAL_COVERAGE"

    # Aseg√∫rate de que la variable no est√© vac√≠a
    if [ -z "$ACTUAL_COVERAGE" ]; then
        echo "‚ùå No se pudo calcular la cobertura. Revisa tu configuraci√≥n."
        exit 1
    fi

    echo "‚úÖ Cobertura actual: ${ACTUAL_COVERAGE}%"

    # Compara la cobertura actual con el m√≠nimo requerido
    MINIMUM_COVERAGE=85
    if [ "$ACTUAL_COVERAGE" -lt "$MINIMUM_COVERAGE" ]; then
        echo "‚ùå La cobertura de c√≥digo es menor que el m√≠nimo requerido (${MINIMUM_COVERAGE}%). No se permitir√° el push."
        exit 1
    fi
else
    echo "‚ùå No se gener√≥ el archivo de cobertura. Revisa tu configuraci√≥n."
    exit 1
fi

echo "‚úîÔ∏è Todas las pruebas pasaron y la cobertura cumple con el est√°ndar."
exit 0

